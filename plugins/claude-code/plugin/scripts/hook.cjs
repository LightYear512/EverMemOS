#!/usr/bin/env node
"use strict";var w=require("os"),_=require("path");function j(){return{url:process.env.EVERMEMOS_URL||"http://localhost:1995",userId:process.env.EVERMEMOS_USER_ID||"claude-code-user",groupPrefix:process.env.EVERMEMOS_GROUP_PREFIX||"cc",timeoutMs:parseInt(process.env.EVERMEMOS_TIMEOUT_MS||"10000",10),searchTopK:parseInt(process.env.EVERMEMOS_SEARCH_TOP_K||"10",10),retrieveMethod:process.env.EVERMEMOS_RETRIEVE_METHOD||"rrf",contextMaxChars:parseInt(process.env.EVERMEMOS_CONTEXT_MAX_CHARS||"4000",10),offsetDir:(0,_.join)((0,w.homedir)(),".evermemos-plugin","offsets"),debug:process.env.EVERMEMOS_DEBUG==="true"}}var m=j();var i={debug(...r){m.debug&&process.stderr.write(`[evermemos:debug] ${r.map(e=>typeof e=="string"?e:JSON.stringify(e)).join(" ")}
`)},info(...r){process.stderr.write(`[evermemos:info] ${r.map(e=>typeof e=="string"?e:JSON.stringify(e)).join(" ")}
`)},warn(...r){process.stderr.write(`[evermemos:warn] ${r.map(e=>typeof e=="string"?e:JSON.stringify(e)).join(" ")}
`)},error(...r){process.stderr.write(`[evermemos:error] ${r.map(e=>typeof e=="string"?e:JSON.stringify(e)).join(" ")}
`)}};var M=require("path");async function S(r,e,t,s=2){let o;for(let n=0;n<=s;n++){let u=new AbortController,p=setTimeout(()=>u.abort(),t);try{let c=await fetch(r,{...e,signal:u.signal});if(clearTimeout(p),c.status>=400&&c.status<500)return c;if(c.status>=500&&n<s){o=new Error(`Server error: ${c.status}`);let a=500*Math.pow(2,n);i.warn(`Retry ${n+1}/${s} after ${a}ms (status ${c.status})`),await new Promise(l=>setTimeout(l,a));continue}return c}catch(c){if(clearTimeout(p),o=c instanceof Error?c:new Error(String(c)),n<s&&!(c instanceof DOMException&&c.name==="AbortError")){let a=500*Math.pow(2,n);i.warn(`Retry ${n+1}/${s} after ${a}ms (${o.message})`),await new Promise(l=>setTimeout(l,a));continue}}}throw o||new Error("Request failed")}var d=class{baseUrl;timeoutMs;constructor(e,t){this.baseUrl=e||m.url,this.timeoutMs=t||m.timeoutMs}async isAvailable(){try{let e=new AbortController,t=setTimeout(()=>e.abort(),5e3),s=await fetch(`${this.baseUrl}/api/v1/memories?limit=1`,{signal:e.signal});return clearTimeout(t),s.ok}catch{return!1}}async storeMessage(e){let t=`${this.baseUrl}/api/v1/memories`;i.debug(`POST ${t}`,{message_id:e.message_id});let s=await S(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},this.timeoutMs);if(!s.ok){let o=await s.text().catch(()=>"");throw new Error(`storeMessage failed (${s.status}): ${o}`)}return await s.json()}async searchMemories(e){let t=new URLSearchParams;e.query&&t.set("query",e.query),e.retrieve_method&&t.set("retrieve_method",e.retrieve_method),e.memory_types&&t.set("memory_types",e.memory_types),e.user_id&&t.set("user_id",e.user_id),e.group_id&&t.set("group_id",e.group_id),e.top_k!==void 0&&t.set("top_k",String(e.top_k));let s=`${this.baseUrl}/api/v1/memories/search?${t}`;i.debug(`GET ${s}`);let o=await S(s,{method:"GET"},this.timeoutMs);if(!o.ok){let n=await o.text().catch(()=>"");throw new Error(`searchMemories failed (${o.status}): ${n}`)}return await o.json()}async fetchMemories(e){let t=new URLSearchParams;e.memory_type&&t.set("memory_type",e.memory_type),e.user_id&&t.set("user_id",e.user_id),e.group_id&&t.set("group_id",e.group_id),e.limit!==void 0&&t.set("limit",String(e.limit)),e.offset!==void 0&&t.set("offset",String(e.offset));let s=`${this.baseUrl}/api/v1/memories?${t}`;i.debug(`GET ${s}`);let o=await S(s,{method:"GET"},this.timeoutMs);if(!o.ok){let n=await o.text().catch(()=>"");throw new Error(`fetchMemories failed (${o.status}): ${n}`)}return await o.json()}async saveConversationMeta(e){let t=`${this.baseUrl}/api/v1/memories/conversation-meta`;i.debug(`POST ${t}`,{group_id:e.group_id});let s=await S(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)},this.timeoutMs);if(!s.ok){let o=await s.text().catch(()=>"");throw new Error(`saveConversationMeta failed (${s.status}): ${o}`)}return await s.json()}};async function v(r){let e=new d(void 0,5e3);if(!await e.isAvailable())return i.debug("EverMemOS not available, skipping context injection"),{};let s=(0,M.basename)(r.cwd);i.debug(`SessionStart for project: ${s}`);let[o,n]=await Promise.allSettled([e.searchMemories({query:s,retrieve_method:m.retrieveMethod,memory_types:"episodic_memory",top_k:m.searchTopK}),e.fetchMemories({memory_type:"profile",limit:3})]),u=[];if(n.status==="fulfilled"&&n.value.result?.memories?.length){u.push("## User Profile");for(let c of n.value.result.memories){let a=c.content||c.summary||"";a&&u.push(`- ${a}`)}}if(o.status==="fulfilled"&&o.value.result?.memories?.length){let c=[];for(let a of o.value.result.memories)for(let l of Object.values(a))c.push(...l);if(c.length>0){u.push("## Relevant Past Context");for(let a of c){let l=a.timestamp||"",y=a.summary||a.episode||a.subject||"";y&&u.push(`- [${l}] ${y}`)}}}if(u.length===0)return{};let p=`# EverMemOS Memories

`+u.join(`
`);return p.length>m.contextMaxChars&&(p=p.substring(0,m.contextMaxChars)+`

...(truncated)`),i.debug(`Injecting ${p.length} chars of context`),{additionalContext:p}}var x=require("path");var b=require("fs");function E(r){return r.replace(/<system-reminder>[\s\S]*?<\/system-reminder>/g,"").trim()}function H(r){if(!r.message?.content)return"";let e=r.message.content;if(typeof e=="string")return E(e);if(Array.isArray(e)){let t=[];for(let o of e)o.type==="text"&&o.text?t.push(o.text):o.type==="tool_use"&&o.name&&t.push(`[Used tool: ${o.name}]`);let s=t.join(`
`);return E(s)}return""}function O(r,e){let t;try{t=(0,b.readFileSync)(r,"utf-8")}catch(n){return i.error(`Failed to read transcript: ${r}`,n),[]}let s=t.split(`
`).filter(n=>n.trim()!==""),o=[];for(let n=e;n<s.length;n++){let u;try{u=JSON.parse(s[n])}catch{i.warn(`Failed to parse transcript line ${n}: ${s[n].substring(0,100)}`);continue}if(u.type==="summary"||u.type==="system"||u.type!=="user"&&u.type!=="assistant")continue;let p=H(u);p&&o.push({uuid:u.uuid||`line-${n}`,timestamp:u.timestamp||new Date().toISOString(),role:u.type,content:p,lineNumber:n})}return o}var f=require("fs"),g=require("path");function N(r){return r.replace(/[^a-zA-Z0-9\-_]/g,"_")}function P(r){return(0,g.join)(m.offsetDir,`${N(r)}.json`)}function k(r){let e=P(r);try{let t=(0,f.readFileSync)(e,"utf-8");return JSON.parse(t).lastLine}catch{return 0}}function $(r,e){let t=P(r),s=(0,g.dirname)(t);try{(0,f.mkdirSync)(s,{recursive:!0})}catch{}let o={lastLine:e,updatedAt:new Date().toISOString()},n=t+".tmp";(0,f.writeFileSync)(n,JSON.stringify(o),"utf-8"),(0,f.renameSync)(n,t)}function C(){let e=Date.now();try{(0,f.mkdirSync)(m.offsetDir,{recursive:!0})}catch{}let t;try{t=(0,f.readdirSync)(m.offsetDir)}catch{return}for(let s of t){if(!s.endsWith(".json"))continue;let o=(0,g.join)(m.offsetDir,s);try{let n=(0,f.statSync)(o);e-n.mtimeMs>6048e5&&((0,f.unlinkSync)(o),i.debug(`Cleaned up old offset file: ${s}`))}catch{}}}async function h(r){let e=new d,t=r.session_id,s=r.transcript_path;if(!s){i.debug("No transcript path, skipping");return}let o=k(t),n=O(s,o);if(n.length===0){i.debug("No new transcript entries");return}i.debug(`Processing ${n.length} new entries from offset ${o}`);let u=`${m.groupPrefix}-${t}`,p=(0,x.basename)(r.cwd);if(o===0)try{let a={version:"1.0.0",scene:"assistant",scene_desc:{},name:p,description:`Claude Code session: ${p}`,group_id:u,created_at:new Date().toISOString(),default_timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",user_details:{[m.userId]:{full_name:"User",role:"user",extra:{}},assistant:{full_name:"Claude",role:"assistant",extra:{}}},tags:["claude-code",p]};await e.saveConversationMeta(a),i.debug("Conversation metadata saved")}catch(a){i.warn("Failed to save conversation metadata:",a)}let c=o;for(let a of n){let l={message_id:a.uuid,create_time:a.timestamp,sender:a.role==="user"?m.userId:"assistant",content:a.content,group_id:u,group_name:p,sender_name:a.role==="user"?"User":"Claude",role:a.role};try{await e.storeMessage(l),c=a.lineNumber+1}catch(y){i.error(`Failed to store message ${a.uuid}:`,y);break}}c>o&&($(t,c),i.debug(`Offset updated to ${c}`))}async function R(r){try{await h(r)}catch(e){i.error("Stop handler error:",e)}return{continue:!0}}async function T(r){try{await h(r)}catch(e){i.error("PreCompact handler error:",e)}return{continue:!0}}async function I(r){try{await h(r)}catch(e){i.error("SessionEnd handler error (sendNewMessages):",e)}try{C(),i.debug("Offset cleanup done")}catch(e){i.error("SessionEnd handler error (cleanup):",e)}return{continue:!0}}async function A(){let r;try{let t=[];for await(let o of process.stdin)t.push(Buffer.isBuffer(o)?o:Buffer.from(o));let s=Buffer.concat(t).toString("utf-8");r=JSON.parse(s)}catch(t){i.error("Failed to read/parse stdin:",t),process.stdout.write("{}"),process.exit(0)}let e;try{switch(r.hook_event_name){case"SessionStart":e=await v(r);break;case"Stop":e=await R(r);break;case"PreCompact":e=await T(r);break;case"SessionEnd":e=await I(r);break;default:i.warn(`Unknown hook event: ${r.hook_event_name}`),e={}}}catch(t){i.error(`Hook handler error for ${r.hook_event_name}:`,t),e=r.hook_event_name==="SessionStart"?{}:{continue:!0}}process.stdout.write(JSON.stringify(e)),process.exit(0)}A();
